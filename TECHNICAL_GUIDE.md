# üõ†Ô∏è –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –ø–æ—Å—ñ–±–Ω–∏–∫ EpicService

**–í–µ—Ä—Å—ñ—è:** 2.0.0  
**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** 19.02.2026

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–¥–∞—î –ø–æ–≥–ª–∏–±–ª–µ–Ω–∏–π —Ç–µ—Ö–Ω—ñ—á–Ω–∏–π –æ–≥–ª—è–¥ EpicService, –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤, DevOps-—ñ–Ω–∂–µ–Ω–µ—Ä—ñ–≤ —Ç–∞ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤.

---

## üìö –ó–º—ñ—Å—Ç

1. [–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏](#1-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º–∏)
2. [–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π —Å—Ç–µ–∫](#2-—Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π-—Å—Ç–µ–∫)
3. [–°—Ö–µ–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö](#3-—Å—Ö–µ–º–∞-–±–∞–∑–∏-–¥–∞–Ω–∏—Ö)
4. [Backend (Telegram Bot)](#4-backend-telegram-bot)
5. [WebApp (Mini App + PWA)](#5-webapp-mini-app--pwa)
6. [–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å](#6-–∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å)
7. [–ö–ª—é—á–æ–≤—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å–∏](#7-–∫–ª—é—á–æ–≤—ñ-–±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å–∏)
8. [API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è](#8-api-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è)
9. [–†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è](#9-—Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è)
10. [–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è](#10-–º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥-—Ç–∞-–ª–æ–≥—É–≤–∞–Ω–Ω—è)
11. [–ë–µ–∑–ø–µ–∫–∞](#11-–±–µ–∑–ø–µ–∫–∞)
12. [–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å](#12-–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å)
13. [Troubleshooting](#13-troubleshooting)

---

## 1. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏

### 1.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ        ‚îÇ
‚îÇ  (Telegram Client)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Bot API ‚îÇ ‚îÇ WebApp (PWA)     ‚îÇ
‚îÇ aiogram ‚îÇ ‚îÇ FastAPI + HTML   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        ‚îÇ    ‚îÇ Service Worker
    ‚îå‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚î§ (Offline Cache)
    ‚îÇ   ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ PostgreSQL         ‚îÇ ‚îÇ
‚îÇ (–û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ)   ‚îÇ ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
          ‚îÇ            ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
     ‚îÇ Redis    ‚îÇ       ‚îÇ
     ‚îÇ (FSM)    ‚îÇ       ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
                        ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îê
     ‚îÇ LocalStorage     ‚îÇ
     ‚îÇ IndexedDB        ‚îÇ
     ‚îÇ (–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π)  ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1.2 –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö

1. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí Telegram Bot:**
   - –ö–æ–º–∞–Ω–¥–∏ `/start`, `/admin`
   - Persistent –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ (–∫–Ω–æ–ø–∫–∞ "–ê–¥–º—ñ–Ω–∫–∞")
   - Callback queries (—ñ–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏)

2. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí WebApp:**
   - –í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `web_app` –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç—ñ
   - PWA: –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —è–∫ –¥–æ–¥–∞—Ç–æ–∫
   - REST API –∫–ª–∏–∫–∏ –¥–æ FastAPI

3. **Bot/WebApp ‚Üí PostgreSQL:**
   - Async ORM (SQLAlchemy 2.0)
   - –ó–∞–ø–∏—Å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
   - `FOR UPDATE` locks –¥–ª—è —Ä–µ–∑–µ—Ä–≤—ñ–≤

4. **Bot ‚Üí Redis:**
   - FSM states (—Å—Ç–∞–Ω–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)
   - –¢–∏–º—á–∞—Å–æ–≤–∏–π –∫–µ—à

5. **PWA ‚Üí LocalStorage/Service Worker:**
   - –ö–µ—à—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤
   - –û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º
   - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UI

---

## 2. –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π —Å—Ç–µ–∫

### 2.1 Backend

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—è | –í–µ—Ä—Å—ñ—è |
|------------|--------------|--------|
| **–ú–æ–≤–∞** | Python | 3.11+ |
| **Bot Framework** | aiogram | 3.x |
| **Web Framework** | FastAPI | 0.100+ |
| **ORM** | SQLAlchemy | 2.0 |
| **–ë–î** | PostgreSQL | 14+ |
| **–ö–µ—à** | Redis | 7+ |
| **–ú—ñ–≥—Ä–∞—Ü—ñ—ó** | Alembic | 1.x |
| **Async driver** | asyncpg | - |
| **Excel** | openpyxl | - |
| **Scheduler** | APScheduler | 3.x |

### 2.2 Frontend

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—è |
|------------|---------------|
| **JS Framework** | Vanilla JS (ES6+) |
| **UI** | Telegram WebApp SDK |
| **PWA** | Service Worker API |
| **–°—Ç–∏–ª—ñ** | CSS Variables (—Ç–µ–º—É–≤–∞–Ω–Ω—è) |
| **–û—Ñ–ª–∞–π–Ω** | Cache API + IndexedDB |
| **Templates** | Jinja2 |

### 2.3 DevOps

- **OS:** Ubuntu 22.04 LTS
- **Process Manager:** systemd
- **Web Server:** nginx (reverse proxy)
- **SSL/TLS:** Let's Encrypt (Certbot)
- **Version Control:** Git + GitHub
- **CI/CD:** Manual deployment (ready for GitHub Actions)

---

## 3. –°—Ö–µ–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

### 3.1 ER-–¥—ñ–∞–≥—Ä–∞–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      User          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)           ‚îÇ
‚îÇ username          ‚îÇ
‚îÇ first_name        ‚îÇ
‚îÇ last_name         ‚îÇ
‚îÇ created_at        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1:N
     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    TempList          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)             ‚îÇ
‚îÇ user_id (FK)        ‚îÇ
‚îÇ product_id (FK) ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ quantity            ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ created_at          ‚îÇ ‚îÇ       Product        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                         ‚îÇ id (PK)              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ article (UNIQUE)     ‚îÇ
‚îÇ    SavedList        ‚îÇ ‚îÇ name                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ department           ‚îÇ
‚îÇ id (PK)            ‚îÇ ‚îÇ group_name           ‚îÇ
‚îÇ user_id (FK)       ‚îÇ ‚îÇ price                ‚îÇ
‚îÇ filename           ‚îÇ ‚îÇ available            ‚îÇ
‚îÇ filepath           ‚îÇ ‚îÇ reserved (—Ä–µ–∑–µ—Ä–≤)  ‚îÇ
‚îÇ created_at         ‚îÇ ‚îÇ no_movement          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ is_active            ‚îÇ
   ‚îÇ                    ‚îÇ updated_at           ‚îÇ
   ‚îÇ 1:N                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ
‚îå‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SavedListItem       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)             ‚îÇ
‚îÇ saved_list_id (FK)  ‚îÇ
‚îÇ product_id (FK)     ‚îÇ
‚îÇ quantity            ‚îÇ
‚îÇ price               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.2 –û—Å–Ω–æ–≤–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ

#### **User**
–ó–±–µ—Ä—ñ–≥–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ Telegram.
- `id` ‚Äî Telegram User ID (Primary Key)
- `username`, `first_name`, `last_name` ‚Äî –∑ Telegram
- `created_at` ‚Äî –¥–∞—Ç–∞ –ø–µ—Ä—à–æ–≥–æ –≤—Ö–æ–¥—É

#### **Product**
–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤.
- `id` ‚Äî –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π ID
- `article` ‚Äî —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∞—Ä—Ç–∏–∫—É–ª (UNIQUE INDEX)
- `name`, `department`, `group_name` ‚Äî –æ–ø–∏—Å–æ–≤—ñ –ø–æ–ª—è
- `price`, `available` ‚Äî —Ü—ñ–Ω–∞ —Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
- `reserved` ‚Äî –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)
- `no_movement` ‚Äî –±–µ–∑ —Ä—É—Ö—É (–¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
- `is_active` ‚Äî –º'—è–∫–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è

#### **TempList**
–ü–æ—Ç–æ—á–Ω—ñ (–Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ) —Å–ø–∏—Å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.
- `user_id` + `product_id` ‚Äî composite key
- `quantity` ‚Äî –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É —Å–ø–∏—Å–∫—É

**–õ–æ–≥—ñ–∫–∞:** –ü—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É –≤ —Å–ø–∏—Å–æ–∫ ‚Üí `product.reserved += quantity`

#### **SavedList / SavedListItem**
–ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Å–ø–∏—Å–∫–∏ —Ç–∞ —ó—Ö–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó.
- –ó–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ø—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "üíæ –ó–±–µ—Ä–µ–≥—Ç–∏"
- `filename` / `filepath` ‚Äî Excel —Ñ–∞–π–ª —É `archives/active/`
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## 4. Backend (Telegram Bot)

### 4.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```python
bot.py                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
config.py                 # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (.env)

database/
  engine.py              # Async/Sync engine
  models.py              # SQLAlchemy models
  orm.py                 # ORM queries

handlers/
  common.py              # /start, –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
  webapp_handler.py      # –û–±—Ä–æ–±–∫–∞ webapp_data
  error_handler.py       # –ì–ª–æ–±–∞–ª—å–Ω—ñ –ø–æ–º–∏–ª–∫–∏
  admin/
    core.py              # –û—Å–Ω–æ–≤–Ω—ñ –∞–¥–º—ñ–Ω-–∫–æ–º–∞–Ω–¥–∏
    import_handlers.py   # –Ü–º–ø–æ—Ä—Ç Excel
    report_handlers.py   # –ó–≤—ñ—Ç–∏
    archive_handlers.py  # –ê—Ä—Ö—ñ–≤–∏

keyboards/
  inline.py              # Inline keyboards
  reply.py               # Reply keyboards

middlewares/
  logging_middleware.py  # –õ–æ–≥—É–≤–∞–Ω–Ω—è

utils/
  list_processor.py      # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Excel
  archive_manager.py     # –†–æ—Ç–∞—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤
  admin_helpers.py       # Admin utilities

lexicon/
  lexicon.py             # –¢–µ–∫—Å—Ç–æ–≤—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏
```

### 4.2 FSM (–ú–∞—à–∏–Ω–∞ —Å—Ç–∞–Ω—ñ–≤)

```python
from aiogram.fsm.state import State, StatesGroup

class AdminStates(StatesGroup):
    waiting_for_file = State()         # –û—á—ñ–∫—É—î–º–æ Excel
    waiting_for_confirmation = State() # –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—É
```

**–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ Redis** –∑ TTL.

### 4.3 –û—Å–Ω–æ–≤–Ω—ñ —Ö–µ–Ω–¥–ª–µ—Ä–∏

#### **`/start`**
```python
@router.message(CommandStart())
async def cmd_start(message: Message):
    user_id = message.from_user.id
    await orm_add_user(user_id, ...)
    
    # Persistent keyboard
    keyboard = get_persistent_keyboard(user_id)
    
    # WebApp button
    webapp_keyboard = InlineKeyboardMarkup(
        inline_keyboard=[[
            InlineKeyboardButton(
                text="üåê –í—ñ–¥–∫—Ä–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫",
                web_app=WebAppInfo(url=WEBAPP_URL)
            )
        ]]
    )
```

#### **webapp_data handler**
–û–±—Ä–æ–±–ª—è—î –¥–∞–Ω—ñ –∑ WebApp:
```python
@router.message(F.web_app_data)
async def handle_webapp_data(message: Message):
    data = json.loads(message.web_app_data.data)
    
    if data['action'] == 'save_list':
        # –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–ø–∏—Å–æ–∫
        await process_and_save_list(data['user_id'])
```

---

## 5. WebApp (Mini App + PWA)

### 5.1 –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
webapp/
  api.py                 # FastAPI –¥–æ–¥–∞—Ç–æ–∫
  routers/
    client.py            # User endpoints
    admin.py             # Admin endpoints
  templates/
    index.html           # SPA frontend
  static/
    manifest.json        # PWA manifest
    sw.js                # Service Worker
    pwa-install.js       # –Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—è PWA
    pwa-redirect.js      # –†–µ–¥–∏—Ä–µ–∫—Ç –ª–æ–≥—ñ–∫–∞
    pwa-styles.css       # PWA —Å—Ç–∏–ª—ñ
    admin.html           # –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å
    icons/               # App icons
```

### 5.2 Service Worker

**–°—Ç—Ä–∞—Ç–µ–≥—ñ—è:** Cache First + Network Fallback

```javascript
// sw.js
const CACHE_NAME = 'epicservice-v2.0.0';

const STATIC_ASSETS = [
  '/',
  '/static/manifest.json',
  '/static/pwa-styles.css',
  '/static/icons/icon-192x192.png'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(STATIC_ASSETS))
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => response || fetch(event.request))
  );
});
```

### 5.3 API Endpoints

#### **Client API** (`/api/*`)

| Method | Endpoint | –û–ø–∏—Å |
|--------|----------|------|
| POST | `/api/search` | –ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤ |
| GET | `/api/list/{user_id}` | –ü–æ—Ç–æ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫ |
| POST | `/api/add` | –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä |
| POST | `/api/update` | –û–Ω–æ–≤–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å |
| POST | `/api/delete` | –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä |
| POST | `/api/save/{user_id}` | –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–ø–∏—Å–æ–∫ |
| POST | `/api/clear/{user_id}` | –û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ |
| GET | `/api/archives/{user_id}` | –ê—Ä—Ö—ñ–≤–∏ |
| GET | `/api/archives/download/{filename}` | –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª |
| GET | `/api/archives/download-all/{user_id}` | ZIP –µ–∫—Å–ø–æ—Ä—Ç |
| GET | `/api/statistics/{user_id}` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ |
| GET | `/api/archive/stats/{filename}` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä—Ö—ñ–≤—É |
| GET | `/api/list/department/{user_id}` | –ü–æ—Ç–æ—á–Ω–∏–π –≤—ñ–¥–¥—ñ–ª |

#### **Admin API** (`/api/admin/*`)

| Method | Endpoint | –û–ø–∏—Å |
|--------|----------|------|
| GET | `/api/admin/statistics` | –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| POST | `/api/admin/import` | –Ü–º–ø–æ—Ä—Ç Excel |
| GET | `/api/admin/export/stock` | –ï–∫—Å–ø–æ—Ä—Ç –∑–∞–ª–∏—à–∫—ñ–≤ |
| POST | `/api/admin/force-save/{user_id}` | –ü—Ä–∏–º—É—Å–æ–≤–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è |
| POST | `/api/admin/broadcast` | –†–æ–∑—Å–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å |
| GET | `/api/admin/users/all` | –í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ |
| GET | `/api/admin/users/active` | –ê–∫—Ç–∏–≤–Ω—ñ —Å–ø–∏—Å–∫–∏ |
| GET | `/api/admin/products/info` | –Ü–Ω—Ñ–æ –ø—Ä–æ —Ç–æ–≤–∞—Ä–∏ |
| GET | `/api/admin/reserved/by-department` | –†–µ–∑–µ—Ä–≤–∏ –ø–æ –≤—ñ–¥–¥—ñ–ª–∞—Ö |
| GET | `/api/admin/archives` | –í—Å—ñ –∞—Ä—Ö—ñ–≤–∏ –≤—Å—ñ—Ö —é–∑–µ—Ä—ñ–≤ |
| GET | `/api/admin/archives/download/{filename}` | –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—Ä—Ö—ñ–≤ |
| GET | `/api/admin/archives/download-all` | ZIP –≤—Å—ñ—Ö –∞—Ä—Ö—ñ–≤—ñ–≤ |

---

## 6. –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å

### 6.1 –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª

#### **6.1.1 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

**–ö–ª—ñ–∫–∞ –±—ñ–ª—å–Ω—ñ –∫–∞—Ä—Ç–∫–∏:**
```javascript
// –ö–∞—Ä—Ç–∫–∞ "–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ"
<div class="admin-stat-card" onclick="showAllUsers()">
  <div class="admin-stat-icon">üë•</div>
  <div class="admin-stat-value">${data.total_users}</div>
  <div class="admin-stat-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
</div>

// –ü—Ä–∏ –∫–ª—ñ–∫—É ‚Üí –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑—ñ —Å–ø–∏—Å–∫–æ–º
function showAllUsers() {
  fetch('/api/admin/users/all?user_id=' + userId)
    .then(r => r.json())
    .then(data => renderUsersModal(data));
}
```

**–î–æ—Å—Ç—É–ø–Ω—ñ –∫–∞—Ä—Ç–∫–∏:**
1. üë• **–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** ‚Üí —Å–ø–∏—Å–æ–∫ –∑ ID, —ñ–º'—è–º, –¥–∞—Ç–æ—é —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
2. üî• **–ê–∫—Ç–∏–≤–Ω—ñ —Å–ø–∏—Å–∫–∏** ‚Üí –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ + –ø—Ä–∏–º—É—Å–æ–≤–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
3. üì¶ **–¢–æ–≤–∞—Ä–∏** ‚Üí —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ñ–¥–¥—ñ–ª–∞—Ö, –≥—Ä—É–ø–∞—Ö
4. üí∞ **–†–µ–∑–µ—Ä–≤–∏** ‚Üí –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ —Å—É–º–∏ –ø–æ –≤—ñ–¥–¥—ñ–ª–∞—Ö (–∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏)

#### **6.1.2 –Ü–º–ø–æ—Ä—Ç Excel**

**Drag & Drop —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```javascript
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  const files = e.dataTransfer.files;
  if (files.length > 0 && files[0].name.match(/\.(xlsx|xls)$/)) {
    selectedFile = files[0];
    document.getElementById('uploadBtn').disabled = false;
  }
});

async function uploadFile() {
  const formData = new FormData();
  formData.append('file', selectedFile);
  
  const notifyUsers = document.getElementById('notifyUsers').checked;
  
  const response = await fetch(
    `/api/admin/import?user_id=${userId}&notify_users=${notifyUsers}`,
    { method: 'POST', body: formData }
  );
  
  const result = await response.json();
  // –ü–æ–∫–∞–∑—É—î: –¥–æ–¥–∞–Ω–æ X, –æ–Ω–æ–≤–ª–µ–Ω–æ Y, –¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ Z
}
```

**–§–æ—Ä–º–∞—Ç Excel:**
- **–°—Ç–æ–≤–ø—Ü—ñ:** –ê—Ä—Ç–∏–∫—É–ª, –ù–∞–∑–≤–∞, –í—ñ–¥–¥—ñ–ª, –ì—Ä—É–ø–∞, –¶—ñ–Ω–∞, –î–æ—Å—Ç—É–ø–Ω–æ, –ë–µ–∑ —Ä—É—Ö—É
- **–°–∏–Ω–æ–Ω—ñ–º–∏ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è** (config: `column_synonyms.json`)

**–ü—Ä–æ—Ü–µ—Å —ñ–º–ø–æ—Ä—Ç—É:**
1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É —Ñ–∞–π–ª—É
2. –ü–∞—Ä—Å–∏–Ω–≥ Excel ‚Üí —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤
3. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –ë–î:
   - –ù–æ–≤—ñ ‚Üí INSERT
   - –Ü—Å–Ω—É—é—á—ñ ‚Üí UPDATE
   - –í—ñ–¥—Å—É—Ç–Ω—ñ –≤ —Ñ–∞–π–ª—ñ ‚Üí `is_active = False`
4. –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: —Ä–æ–∑—Å–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º

#### **6.1.3 –ü—Ä–∏–º—É—Å–æ–≤–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è**

```python
@router.post("/api/admin/force-save/{target_user_id}")
async def admin_force_save(
    target_user_id: int,
    user_id: int = Query(...)
):
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–¥–º—ñ–Ω–∞
    if user_id not in ADMIN_IDS:
        raise HTTPException(403, "Forbidden")
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–ø–∏—Å–æ–∫ target_user_id
    await process_and_save_list(target_user_id)
    
    # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
    await bot.send_message(
        target_user_id,
        "‚úÖ –í–∞—à —Å–ø–∏—Å–æ–∫ –±—É–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
    )
    
    return {"success": True, "message": "–°–ø–∏—Å–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ"}
```

**UI:**
- –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ "–ê–∫—Ç–∏–≤–Ω—ñ —Å–ø–∏—Å–∫–∏"
- –ö–Ω–æ–ø–∫–∞ üíæ –±—ñ–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

#### **6.1.4 –†–æ–∑—Å–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**

```javascript
async function sendBroadcast() {
  const message = document.getElementById('broadcastMessage').value.trim();
  
  if (!message) {
    alert('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
    return;
  }
  
  const response = await fetch(
    `/api/admin/broadcast?user_id=${userId}`,
    {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ user_id: userId, message: message })
    }
  );
  
  const result = await response.json();
  alert(`‚úÖ –†–æ–∑—ñ—Å–ª–∞–Ω–æ ${result.sent} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º`);
}
```

**Backend:**
```python
@router.post("/api/admin/broadcast")
async def admin_broadcast(
    request: BroadcastRequest,
    user_id: int = Query(...)
):
    if user_id not in ADMIN_IDS:
        raise HTTPException(403)
    
    users = await get_all_users()
    sent_count = 0
    
    for user in users:
        try:
            await bot.send_message(user.id, request.message)
            sent_count += 1
        except Exception as e:
            logger.error(f"Failed to send to {user.id}: {e}")
    
    return {"success": True, "sent": sent_count}
```

#### **6.1.5 –ï–∫—Å–ø–æ—Ä—Ç –∑–≤—ñ—Ç—ñ–≤**

**–ó–≤—ñ—Ç –ø—Ä–æ –∑–∞–ª–∏—à–∫–∏ (Excel):**
```python
@router.get("/api/admin/export/stock")
async def export_stock(user_id: int = Query(...)):
    if user_id not in ADMIN_IDS:
        raise HTTPException(403)
    
    products = await get_all_active_products()
    
    wb = Workbook()
    ws = wb.active
    ws.title = "–ó–∞–ª–∏—à–∫–∏"
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    ws.append(["–ê—Ä—Ç–∏–∫—É–ª", "–ù–∞–∑–≤–∞", "–í—ñ–¥–¥—ñ–ª", "–î–æ—Å—Ç—É–ø–Ω–æ", "–ó–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–æ", "–¶—ñ–Ω–∞"])
    
    # –î–∞–Ω—ñ
    for p in products:
        ws.append([p.article, p.name, p.department, p.available, p.reserved, p.price])
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ
    filename = f"stock_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
    filepath = f"archives/reports/{filename}"
    wb.save(filepath)
    
    return FileResponse(filepath, filename=filename)
```

**ZIP –≤—Å—ñ—Ö –∞—Ä—Ö—ñ–≤—ñ–≤:**
```python
@router.get("/api/admin/archives/download-all")
async def download_all_archives(user_id: int = Query(...)):
    if user_id not in ADMIN_IDS:
        raise HTTPException(403)
    
    zip_filename = f"all_archives_{datetime.now().strftime('%Y%m%d_%H%M%S')}.zip"
    zip_path = f"archives/temp/{zip_filename}"
    
    with zipfile.ZipFile(zip_path, 'w') as zipf:
        for user_folder in Path("archives/active").iterdir():
            for file in user_folder.glob("*.xlsx"):
                zipf.write(file, arcname=f"{user_folder.name}/{file.name}")
    
    return FileResponse(zip_path, filename=zip_filename)
```

---

## 7. –ö–ª—é—á–æ–≤—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å–∏

### 7.1 –†–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤

```python
async def add_to_list(user_id: int, product_id: int, quantity: int):
    async with async_session_maker() as session:
        async with session.begin():
            # 1. –î–æ–¥–∞—î–º–æ –≤ TempList
            await session.execute(
                insert(TempList).values(
                    user_id=user_id,
                    product_id=product_id,
                    quantity=quantity
                )
            )
            
            # 2. –†–µ–∑–µ—Ä–≤—É—î–º–æ –≤ Product
            await session.execute(
                update(Product)
                .where(Product.id == product_id)
                .values(reserved=Product.reserved + quantity)
            )
```

### 7.2 –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥–¥—ñ–ª—ñ–≤

–õ–æ–≥—ñ–∫–∞ –≤ `client.py` (`/api/search`):

```python
# –ü–µ—Ä—à–∏–π —Ç–æ–≤–∞—Ä —É —Å–ø–∏—Å–∫—É –≤–∏–∑–Ω–∞—á–∞—î –≤—ñ–¥–¥—ñ–ª
current_department = await get_user_current_department(user_id)

for product in products:
    product['is_different_department'] = (
        current_department is not None and 
        product['department'] != current_department
    )
```

**Frontend:**
```javascript
if (product.is_different_department) {
  card.classList.add('locked');
  card.onclick = null; // –ë–ª–æ–∫—É—î–º–æ –∫–ª—ñ–∫
}
```

### 7.3 –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É

```python
async def process_and_save_list(user_id: int):
    async with async_session_maker() as session:
        async with session.begin():
            # 1. –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫
            temp_list = await get_temp_list(user_id)
            
            # 2. –ì–µ–Ω–µ—Ä—É—î–º–æ Excel
            filename = f"{user_id}_{timestamp}.xlsx"
            create_excel(temp_list, filename)
            
            # 3. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ SavedList
            saved_list = SavedList(
                user_id=user_id,
                filename=filename,
                filepath=f"archives/active/{user_id}/{filename}"
            )
            session.add(saved_list)
            
            # 4. –ó–≤—ñ–ª—å–Ω—è—î–º–æ —Ä–µ–∑–µ—Ä–≤–∏
            for item in temp_list:
                await session.execute(
                    update(Product)
                    .where(Product.id == item.product_id)
                    .values(reserved=Product.reserved - item.quantity)
                )
            
            # 5. –û—á–∏—â—É—î–º–æ TempList
            await session.execute(
                delete(TempList).where(TempList.user_id == user_id)
            )
```

### 7.4 –†–æ—Ç–∞—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤

**APScheduler –∑–∞–¥–∞—á–∞ (—â–æ–¥–µ–Ω–Ω–æ –æ 03:00):**

```python
from utils.archive_manager import rotate_user_archives

def cleanup_job():
    for user_id in get_all_user_ids():
        rotate_user_archives(user_id, keep_count=10)
    
    cleanup_trash(days=14)

scheduler.add_job(
    cleanup_job,
    'cron',
    hour=3,
    minute=0
)
```

---

## 8. API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### 8.1 Swagger UI

–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:
- http://localhost:8000/docs
- http://localhost:8000/redoc

### 8.2 –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É

#### **POST /api/search**

```bash
curl -X POST "http://localhost:8000/api/search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "12345",
    "user_id": 123456789
  }'
```

**Response:**
```json
{
  "products": [
    {
      "id": 1,
      "article": "12345",
      "name": "–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É",
      "department": "–í—ñ–¥–¥—ñ–ª A",
      "price": 100.50,
      "available": 10,
      "reserved": 2,
      "is_different_department": false
    }
  ]
}
```

---

## 9. –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è

### 9.1 –í–∏–º–æ–≥–∏

- Ubuntu 22.04 LTS
- Python 3.11+
- PostgreSQL 14+
- Redis 7+
- nginx
- SSL certificate (Let's Encrypt)

### 9.2 –ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è

```bash
# 1. –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è
git clone https://github.com/imeromua/epicservice.git
cd epicservice

# 2. –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –æ—Ç–æ—á–µ–Ω–Ω—è
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 3. PostgreSQL
sudo -u postgres psql
CREATE DATABASE epicservice;
CREATE USER epicuser WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE epicservice TO epicuser;
\q

# 4. –ú—ñ–≥—Ä–∞—Ü—ñ—ó
alembic upgrade head

# 5. .env
cp .env.example .env
nano .env

# 6. systemd services
sudo cp deploy/epicservice.service /etc/systemd/system/
sudo cp deploy/webapp.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable epicservice webapp
sudo systemctl start epicservice webapp

# 7. nginx
sudo cp deploy/nginx.conf /etc/nginx/sites-available/epicservice
sudo ln -s /etc/nginx/sites-available/epicservice /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 8. SSL
sudo certbot --nginx -d your-domain.com
```

---

## 10. –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è

### 10.1 –õ–æ–≥–∏

```bash
# Bot logs
journalctl -u epicservice -f
tail -f bot.log

# WebApp logs
journalctl -u webapp -f

# nginx logs
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 10.2 –ú–µ—Ç—Ä–∏–∫–∏

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
curl http://localhost:8000/health

# PostgreSQL connections
psql -U epicuser -d epicservice -c "SELECT count(*) FROM pg_stat_activity;"

# Redis info
redis-cli INFO

# –î–∏—Å–∫–æ–≤–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –∞—Ä—Ö—ñ–≤—ñ–≤
du -sh archives/active/
du -sh archives/trash/
```

---

## 11. –ë–µ–∑–ø–µ–∫–∞

### 11.1 –ó–∞—Ö–æ–¥–∏

- ‚úÖ HTTPS/TLS 1.3
- ‚úÖ User ID –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ –∫–æ–∂–Ω–æ–º—É endpoint
- ‚úÖ ADMIN_IDS whitelist
- ‚úÖ SQL Injection –∑–∞—Ö–∏—Å—Ç (ORM)
- ‚úÖ CORS –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ
- ‚úÖ Rate limiting
- ‚úÖ SSH keys only

### 11.2 Firewall

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 11.3 –†–µ–≥—É–ª—è—Ä–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
# –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
sudo apt update && sudo apt upgrade -y

# –û–Ω–æ–≤–ª–µ–Ω–Ω—è Python –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
source venv/bin/activate
pip install --upgrade -r requirements.txt
```

---

## 12. –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

### 12.1 –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

- **PostgreSQL:**
  - Connection pooling (asyncpg)
  - Indexes –Ω–∞ `article`, `department`
  - `FOR UPDATE` locks –¥–ª—è —Ä–µ–∑–µ—Ä–≤—ñ–≤

- **Redis:**
  - FSM storage
  - TTL –¥–ª—è —Å—Ç–∞–Ω—ñ–≤

- **PWA:**
  - Service Worker cache
  - Lazy loading
  - Debounce –ø–æ—à—É–∫—É (500ms)

### 12.2 Benchmark

```bash
# API endpoint
ab -n 1000 -c 10 http://localhost:8000/health

# PostgreSQL
pgbench -i -s 50 epicservice
pgbench -c 10 -j 2 -t 1000 epicservice
```

---

## 13. Troubleshooting

### 13.1 Bot –Ω–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ .env
cat .env

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ PostgreSQL
psql -U epicuser -d epicservice -c "\dt"

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Redis
redis-cli PING

# –õ–æ–≥–∏
journalctl -u epicservice -n 50
```

### 13.2 WebApp 404

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ nginx
sudo nginx -t
sudo systemctl status nginx

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ webapp service
sudo systemctl status webapp

# –õ–æ–≥–∏ nginx
tail -f /var/log/nginx/error.log
```

### 13.3 –†–µ–∑–µ—Ä–≤–∏ –Ω–µ –∑–≤—ñ–ª—å–Ω—è—é—Ç—å—Å—è

```sql
-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∏
SELECT article, reserved FROM products WHERE reserved > 0;

-- –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∑–µ—Ä–≤–∏ (–û–ë–ï–†–ï–ñ–ù–û!)
UPDATE products SET reserved = 0;

-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ TempList
SELECT user_id, COUNT(*) FROM temp_list GROUP BY user_id;
```

### 13.4 PWA –Ω–µ –∫–µ—à—É—î—Ç—å—Å—è

```javascript
// –í—ñ–¥–∫—Ä–∏—Ç–∏ DevTools ‚Üí Application ‚Üí Service Workers
// –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å Service Worker

// –ü—Ä–∏–º—É—Å–æ–≤–æ –æ–Ω–æ–≤–∏—Ç–∏ SW
navigator.serviceWorker.getRegistrations().then(registrations => {
  registrations.forEach(reg => reg.unregister());
  location.reload();
});
```

### 13.5 –ê—Ä—Ö—ñ–≤–∏ –Ω–µ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ APScheduler
grep -r "cleanup_job" bot.log

# –ü—Ä–∏–º—É—Å–æ–≤–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ cleanup
python -c "from utils.archive_manager import cleanup_trash; cleanup_trash(days=14)"

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É
ls -la archives/trash/
```

### 13.6 –Ü–º–ø–æ—Ä—Ç Excel –ø–∞–¥–∞—î

```python
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É
import openpyxl
wb = openpyxl.load_workbook('file.xlsx')
ws = wb.active
print(ws['A1'].value)  # –ú–∞—î –±—É—Ç–∏ "–ê—Ä—Ç–∏–∫—É–ª" –∞–±–æ —Å–∏–Ω–æ–Ω—ñ–º

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–∏–Ω–æ–Ω—ñ–º–∏
cat column_synonyms.json

# –õ–æ–≥–∏
tail -f bot.log | grep "import"
```

---

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

**Email:** [imerom25@gmail.com](mailto:imerom25@gmail.com)  
**Telegram:** [@my_life_ukr](https://t.me/my_life_ukr)  
**GitHub:** [github.com/imeromua/epicservice](https://github.com/imeromua/epicservice)

---

**–í–µ—Ä—Å—ñ—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 2.0.0  
**–û—Å—Ç–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** 19.02.2026
