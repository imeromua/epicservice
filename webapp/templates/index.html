<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EpicService</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#x1F4E6;</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); padding-bottom: 80px; }
        .sticky-container { position: sticky; top: 0; z-index: 100; background: var(--tg-theme-bg-color, #ffffff); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header { padding: 16px 16px 8px 16px; }
        h1 { color: var(--tg-theme-button-color, #0088cc); font-size: 24px; margin-bottom: 8px; }
        .search-box { position: relative; margin-bottom: 12px; padding: 0 16px; }
        .search-input { width: 100%; padding: 12px 16px; border: 2px solid var(--tg-theme-button-color, #0088cc); border-radius: 12px; font-size: 16px; background: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); }
        .search-input:focus { outline: none; border-color: var(--tg-theme-link-color, #0088cc); }
        .tabs { display: flex; gap: 4px; padding: 0 16px 8px 16px; border-bottom: 1px solid var(--tg-theme-hint-color, #999999); overflow-x: auto; }
        .tab { position: relative; padding: 12px 16px; background: none; border: none; color: var(--tg-theme-hint-color, #999999); cursor: pointer; font-size: 14px; border-bottom: 2px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .tab.active { color: var(--tg-theme-button-color, #0088cc); border-bottom-color: var(--tg-theme-button-color, #0088cc); }
        .tab-badge { position: absolute; top: 6px; right: 8px; background: #ff3b30; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center; }
        .main-content { padding: 16px; }
        .content { display: none; }
        .content.active { display: block; }
        .product-card, .list-item, .archive-item { background: var(--tg-theme-secondary-bg-color, #f0f0f0); border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: transform 0.2s; }
        .product-card:active, .list-item:active { transform: scale(0.98); }
        .product-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .product-article { font-weight: bold; color: var(--tg-theme-button-color, #0088cc); font-size: 16px; }
        .product-status { background: #34c759; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .product-name { font-size: 14px; margin-bottom: 12px; color: var(--tg-theme-text-color, #000000); }
        .product-details { display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: var(--tg-theme-hint-color, #999999); }
        .product-detail-row { display: flex; justify-content: space-between; }
        .product-detail-label { font-weight: 500; }
        .product-detail-value { color: var(--tg-theme-text-color, #000000); }
        .product-detail-value.highlight { color: var(--tg-theme-button-color, #0088cc); font-weight: bold; }
        .product-detail-value.warning { color: #ff9500; font-weight: bold; }
        .product-detail-value.success { color: #34c759; font-weight: bold; }
        .list-header, .archive-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .action-buttons { display: flex; gap: 8px; margin-bottom: 16px; }
        .save-btn { flex: 1; padding: 12px; background: #34c759; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .clear-btn { flex: 1; padding: 12px; background: #ff3b30; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .download-btn { flex: 1; padding: 12px; background: var(--tg-theme-button-color, #0088cc); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .delete-archive-btn { flex: 1; padding: 12px; background: #ff3b30; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--tg-theme-hint-color, #999999); }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .loader { text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #999999); }
        .total-box { position: fixed; bottom: 0; left: 0; right: 0; background: var(--tg-theme-bg-color, #ffffff); border-top: 1px solid var(--tg-theme-hint-color, #999999); padding: 16px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .total-text { font-size: 18px; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--tg-theme-bg-color, #ffffff); border-radius: 16px; padding: 24px; max-width: 90%; max-height: 80%; overflow-y: auto; }
        .quantity-selector { display: flex; align-items: center; gap: 16px; margin: 20px 0; justify-content: center; }
        .qty-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--tg-theme-button-color, #0088cc); background: var(--tg-theme-button-color, #0088cc); color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .qty-display { font-size: 24px; font-weight: bold; min-width: 60px; text-align: center; }
        .quick-actions { display: flex; gap: 8px; margin-bottom: 12px; }
        .quick-btn { flex: 1; padding: 12px; background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color, #000000); border: 2px solid var(--tg-theme-button-color, #0088cc); border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .quick-btn:active { transform: scale(0.95); background: var(--tg-theme-button-color, #0088cc); color: white; }
        .add-btn { width: 100%; padding: 16px; background: var(--tg-theme-button-color, #0088cc); color: var(--tg-theme-button-text-color, #ffffff); border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 12px; }
        .delete-btn { background: #ff3b30; }
        .cancel-btn { background: #999 !important; }
        .custom-input { width: 100%; padding: 12px; border: 2px solid var(--tg-theme-button-color, #0088cc); border-radius: 8px; font-size: 18px; text-align: center; margin: 16px 0; background: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); }
        .archive-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-left: 8px; }
        .archive-badge.main { background: #34c759; color: white; }
        .archive-badge.surplus { background: #ff9500; color: white; }
        .archive-stats { font-size: 12px; color: var(--tg-theme-hint-color, #999999); margin-top: 8px; padding: 8px; background: rgba(0,136,204,0.05); border-radius: 8px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .stat-row:last-child { margin-bottom: 0; }
        .stat-label { font-weight: 500; }
        .stat-value { color: var(--tg-theme-button-color, #0088cc); font-weight: bold; }
        .success-icon { font-size: 64px; text-align: center; margin-bottom: 12px; }
        .success-title { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #34c759; }
        .success-subtitle { text-align: center; font-size: 14px; color: var(--tg-theme-hint-color, #999999); margin-bottom: 24px; }
        .archive-actions { display: flex; gap: 8px; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="sticky-container">
        <div class="header">
            <h1>üì¶ EpicService</h1>
            <p id="userInfo">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
        <div class="search-box" id="searchBoxContainer">
            <input type="text" id="searchInput" class="search-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞—Ä—Ç–∏–∫—É–ª –∞–±–æ –Ω–∞–∑–≤—É...">
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">üîç –ü–æ—à—É–∫</button>
            <button class="tab" onclick="switchTab('list')">üìã –°–ø–∏—Å–æ–∫<span class="tab-badge" id="listBadge" style="display:none">0</span></button>
            <button class="tab" onclick="switchTab('archives')">üìÅ –ê—Ä—Ö—ñ–≤</button>
        </div>
    </div>

    <div class="main-content">
        <div id="searchTab" class="content active">
            <div id="searchResults"></div>
        </div>
        <div id="listTab" class="content">
            <div id="listContent"></div>
        </div>
        <div id="archivesTab" class="content">
            <div id="archivesContent"></div>
        </div>
    </div>

    <div id="successModal" class="modal"><div class="modal-content"><div class="success-icon">‚úÖ</div><div class="success-title">–°–ø–∏—Å–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!</div><div class="success-subtitle">–§–∞–π–ª –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–ê—Ä—Ö—ñ–≤"</div><button class="add-btn" style="margin-top:0" onclick="goToArchives()">üìÅ –í—ñ–¥–∫—Ä–∏—Ç–∏ –ê—Ä—Ö—ñ–≤</button><button class="add-btn cancel-btn" onclick="startNewSearch()">üîç –ù–æ–≤–∏–π –ø–æ—à—É–∫</button></div></div>
    <div id="addModal" class="modal"><div class="modal-content"><h2 id="modalTitle"></h2><p id="modalPrice"></p><p id="modalAvailable"></p><div class="quick-actions" style="margin-top:16px"><button class="quick-btn" onclick="addAllAvailable()">‚ûï –î–æ–¥–∞—Ç–∏ –≤—Å–µ</button><button class="quick-btn" onclick="showCustomInput()">üî¢ –Ü–Ω—à–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å</button></div><div id="customInputBox" style="display:none"><input type="number" id="customQtyInput" class="custom-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å" min="1"><button class="add-btn" style="margin-top:0" onclick="applyCustomQty()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button></div><div id="normalSelector"><div class="quantity-selector"><button class="qty-btn" onclick="changeQty(-1)">‚àí</button><div class="qty-display" id="qtyDisplay">1</div><button class="qty-btn" onclick="changeQty(1)">+</button></div><button class="add-btn" style="margin-top:0" onclick="confirmAdd()">üõí –î–æ–¥–∞—Ç–∏ –¥–æ —Å–ø–∏—Å–∫—É</button></div><button class="add-btn cancel-btn" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div></div>
    <div id="editModal" class="modal"><div class="modal-content"><h2 id="editModalTitle"></h2><p id="editModalPrice"></p><div class="quantity-selector"><button class="qty-btn" onclick="changeEditQty(-1)">‚àí</button><div class="qty-display" id="editQtyDisplay">1</div><button class="qty-btn" onclick="changeEditQty(1)">+</button></div><button class="add-btn" style="margin-top:0" onclick="confirmUpdate()">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏</button><button class="add-btn delete-btn" onclick="confirmDelete()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button><button class="add-btn cancel-btn" onclick="closeEditModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div></div>
    <div class="total-box" id="totalBox" style="display:none"><div class="total-text">–í—Å—å–æ–≥–æ: <span id="totalSum">0</span> –≥—Ä–Ω</div><div style="font-size:14px; color:var(--tg-theme-hint-color,#999)"><span id="totalItems">0</span> —Ç–æ–≤–∞—Ä—ñ–≤</div></div>
<script>
const tg = window.Telegram.WebApp; tg.expand();
const userId = tg.initDataUnsafe?.user?.id || 0;
let currentQuantity = 1, editQuantity = 1, selectedProduct = null, editingItem = null, searchTimeout = null, currentTab = 'search';
let cachedProducts = []; // –ö–µ—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É
document.getElementById('userInfo').textContent = userId ? `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${tg.initDataUnsafe.user.first_name}` : '–¢–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º';

function updateListBadge(count) { const badge = document.getElementById('listBadge'); if (count > 0) { badge.textContent = count; badge.style.display = 'block'; } else { badge.style.display = 'none'; } }
function updateSearchBoxVisibility() { const searchBox = document.getElementById('searchBoxContainer'); if (currentTab === 'search') { searchBox.style.display = 'block'; } else { searchBox.style.display = 'none'; } }
function switchTab(tab) { currentTab = tab; document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.content').forEach(c => c.classList.remove('active')); const tabs = {'search': [0,'searchTab'], 'list': [1,'listTab'], 'archives': [2,'archivesTab']}; const [idx, id] = tabs[tab]; document.querySelectorAll('.tab')[idx].classList.add('active'); document.getElementById(id).classList.add('active'); updateSearchBoxVisibility(); if (tab === 'list') loadList(); if (tab === 'archives') loadArchives(); }
function goToArchives() { document.getElementById('successModal').classList.remove('active'); switchTab('archives'); }
function startNewSearch() { document.getElementById('successModal').classList.remove('active'); switchTab('search'); document.getElementById('searchInput').focus(); }
document.getElementById('searchInput').addEventListener('input', (e) => { clearTimeout(searchTimeout); const query = e.target.value.trim(); if (query.length < 2) { document.getElementById('searchResults').innerHTML = ''; cachedProducts = []; return; } searchTimeout = setTimeout(() => search(query), 500); });

function renderProduct(p) {
    return `<div class="product-card" data-product-id="${p.id}" onclick='openAddModal(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
        <div class="product-header">
            <span class="product-article">üÜî ${p.article}</span>
            <span class="product-status">‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ</span>
        </div>
        <div class="product-name">üìù ${p.name}</div>
        <div class="product-details">
            <div class="product-detail-row"><span class="product-detail-label">üè¢ –í—ñ–¥–¥—ñ–ª:</span><span class="product-detail-value">${p.department}</span></div>
            <div class="product-detail-row"><span class="product-detail-label">üìÇ –ì—Ä—É–ø–∞:</span><span class="product-detail-value">${p.group}</span></div>
            <div class="product-detail-row"><span class="product-detail-label">‚è≥ –ë–µ–∑ —Ä—É—Ö—É (–º—ñ—Å):</span><span class="product-detail-value ${p.months_without_movement > 3 ? 'warning' : ''}">${p.months_without_movement}</span></div>
            <div class="product-detail-row"><span class="product-detail-label">üí∞ –°—É–º–∞ –∑–∞–ª–∏—à–∫—É:</span><span class="product-detail-value highlight">${p.balance_sum.toFixed(2)} –≥—Ä–Ω</span></div>
            <div class="product-detail-row"><span class="product-detail-label">üì¶ –î–æ—Å—Ç—É–ø–Ω–æ:</span><span class="product-detail-value success">${p.available}</span></div>
            ${p.user_reserved > 0 ? `<div class="product-detail-row"><span class="product-detail-label">üõí –í —Ä–µ–∑–µ—Ä–≤—ñ:</span><span class="product-detail-value warning">${p.user_reserved} (${p.user_reserved_sum.toFixed(2)} –≥—Ä–Ω)</span></div>` : ''}
        </div>
    </div>`;
}

function updateSearchResults() {
    const results = document.getElementById('searchResults');
    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç–æ–≤–∞—Ä–∏ –∑ available > 0
    const visibleProducts = cachedProducts.filter(p => p.available > 0);
    
    if (visibleProducts.length === 0) {
        results.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –≤—Å–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–æ</div>';
        return;
    }
    
    results.innerHTML = visibleProducts.map(p => renderProduct(p)).join('');
}

async function search(query) { 
    const results = document.getElementById('searchResults'); 
    results.innerHTML = '<div class="loader">üîç –ü–æ—à—É–∫...</div>'; 
    try { 
        const response = await fetch('/api/search', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query, user_id: userId}) }); 
        const data = await response.json(); 
        if (!data.products || data.products.length === 0) { 
            results.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>'; 
            cachedProducts = [];
            return; 
        }
        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç–æ–≤–∞—Ä–∏ –∑ available > 0
        cachedProducts = data.products.filter(p => p.available > 0);
        updateSearchResults();
    } catch (error) { 
        results.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div>–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É</div>'; 
        cachedProducts = [];
    } 
}

function openAddModal(product) { selectedProduct = product; currentQuantity = 1; document.getElementById('modalTitle').textContent = product.article; document.getElementById('modalPrice').textContent = `–¶—ñ–Ω–∞: ${product.price.toFixed(2)} –≥—Ä–Ω`; document.getElementById('modalAvailable').textContent = `–î–æ—Å—Ç—É–ø–Ω–æ: ${product.available} —à—Ç.`; document.getElementById('qtyDisplay').textContent = 1; document.getElementById('customInputBox').style.display = 'none'; document.getElementById('normalSelector').style.display = 'block'; document.getElementById('customQtyInput').value = ''; document.getElementById('addModal').classList.add('active'); }
function closeModal() { document.getElementById('addModal').classList.remove('active'); }
function changeQty(d) { currentQuantity = Math.max(1, Math.min(selectedProduct.available, currentQuantity + d)); document.getElementById('qtyDisplay').textContent = currentQuantity; }
function addAllAvailable() { currentQuantity = selectedProduct.available; document.getElementById('qtyDisplay').textContent = currentQuantity; tg.HapticFeedback.notificationOccurred('success'); }
function showCustomInput() { document.getElementById('customInputBox').style.display = 'block'; document.getElementById('normalSelector').style.display = 'none'; document.getElementById('customQtyInput').focus(); }
function applyCustomQty() { const v = parseInt(document.getElementById('customQtyInput').value); if (isNaN(v) || v < 1) { tg.showAlert('‚ùå –í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ'); return; } if (v > selectedProduct.available) { tg.showAlert(`‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º: ${selectedProduct.available} —à—Ç.`); return; } currentQuantity = v; document.getElementById('qtyDisplay').textContent = v; document.getElementById('customInputBox').style.display = 'none'; document.getElementById('normalSelector').style.display = 'block'; tg.HapticFeedback.notificationOccurred('success'); }

async function confirmAdd() { 
    try { 
        const r = await fetch('/api/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: userId, product_id: selectedProduct.id, quantity: currentQuantity}) }); 
        const d = await r.json(); 
        if (d.success) { 
            tg.showAlert(`‚úÖ ${d.message}`); 
            closeModal(); 
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ
            const productIndex = cachedProducts.findIndex(p => p.id === selectedProduct.id);
            if (productIndex !== -1) {
                cachedProducts[productIndex].user_reserved += currentQuantity;
                cachedProducts[productIndex].user_reserved_sum += currentQuantity * selectedProduct.price;
                cachedProducts[productIndex].available -= currentQuantity;
                
                // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
                updateSearchResults();
            }
            
            loadList(); 
        } else { 
            tg.showAlert('‚ùå ' + d.message); 
        } 
    } catch (e) { 
        tg.showAlert('‚ùå ' + e.message); 
    } 
}

function openEditModal(item) { editingItem = item; editQuantity = item.quantity; document.getElementById('editModalTitle').textContent = item.article; document.getElementById('editModalPrice').textContent = `–¶—ñ–Ω–∞: ${item.price.toFixed(2)} –≥—Ä–Ω`; document.getElementById('editQtyDisplay').textContent = editQuantity; document.getElementById('editModal').classList.add('active'); }
function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }
function changeEditQty(d) { editQuantity = Math.max(1, editQuantity + d); document.getElementById('editQtyDisplay').textContent = editQuantity; }
async function confirmUpdate() { try { const r = await fetch('/api/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: userId, product_id: editingItem.product_id, quantity: editQuantity}) }); const d = await r.json(); if (d.success) { tg.showAlert(`‚úÖ ${d.message}`); closeEditModal(); loadList(); } else { tg.showAlert('‚ùå ' + d.message); } } catch (e) { tg.showAlert('‚ùå ' + e.message); } }
async function confirmDelete() { if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä –∑—ñ —Å–ø–∏—Å–∫—É?')) return; try { const r = await fetch('/api/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: userId, product_id: editingItem.product_id}) }); const d = await r.json(); if (d.success) { tg.showAlert(`‚úÖ ${d.message}`); closeEditModal(); loadList(); } else { tg.showAlert('‚ùå ' + d.message); } } catch (e) { tg.showAlert('‚ùå ' + e.message); } }
async function saveList() { try { const r = await fetch(`/api/save/${userId}`, { method: 'POST' }); const d = await r.json(); if (d.success) { tg.HapticFeedback.notificationOccurred('success'); if (d.cleared) loadList(); document.getElementById('successModal').classList.add('active'); } else { tg.showAlert('‚ùå ' + d.message); } } catch (e) { tg.showAlert('‚ùå ' + e.message); } }
async function clearList() { if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫?')) return; try { const r = await fetch(`/api/clear/${userId}`, { method: 'POST' }); const d = await r.json(); if (d.success) { tg.showAlert(`‚úÖ ${d.message}`); loadList(); } else { tg.showAlert('‚ùå ' + d.message); } } catch (e) { tg.showAlert('‚ùå ' + e.message); } }
async function loadList() { const el = document.getElementById('listContent'); el.innerHTML = '<div class="loader">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>'; try { const r = await fetch(`/api/list/${userId}`); const d = await r.json(); if (!d.items || d.items.length === 0) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div>–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>'; document.getElementById('totalBox').style.display = 'none'; updateListBadge(0); return; } let html = '<div class="action-buttons"><button class="save-btn" onclick="saveList()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button><button class="clear-btn" onclick="clearList()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button></div>'; html += d.items.map(item => `<div class="list-item" onclick='openEditModal(${JSON.stringify(item)})'><div class="list-header"><strong>${item.article}</strong><span>${item.total.toFixed(2)} –≥—Ä–Ω</span></div><div>${item.name}</div><div style="margin-top:8px;color:var(--tg-theme-hint-color,#999)">${item.quantity} —à—Ç. √ó ${item.price.toFixed(2)} –≥—Ä–Ω</div></div>`).join(''); el.innerHTML = html; document.getElementById('totalSum').textContent = d.total.toFixed(2); document.getElementById('totalItems').textContent = d.count; document.getElementById('totalBox').style.display = 'flex'; updateListBadge(d.count); } catch (e) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>'; updateListBadge(0); } }

async function loadArchiveStats(filename) { try { const r = await fetch(`/api/archive/stats/${filename}?user_id=${userId}`); const d = await r.json(); if (d.success) { return `<div class="stat-row"><span class="stat-label">üì¶ –¢–æ–≤–∞—Ä—ñ–≤:</span><span class="stat-value">${d.items_count}</span></div><div class="stat-row"><span class="stat-label">üè¢ –í—ñ–¥–¥—ñ–ª:</span><span class="stat-value">${d.department}</span></div><div class="stat-row"><span class="stat-label">üë§ –ê–≤—Ç–æ—Ä:</span><span class="stat-value">ID ${d.author_id}</span></div>`; } return ''; } catch (e) { return ''; } }

async function loadArchives() { const el = document.getElementById('archivesContent'); el.innerHTML = '<div class="loader">üìÅ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>'; try { const r = await fetch(`/api/archives/${userId}`); const d = await r.json(); if (!d.archives || d.archives.length === 0) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div>–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>'; return; } let html = ''; for (const a of d.archives) { const stats = await loadArchiveStats(a.filename); html += `<div class="archive-item"><div class="archive-header"><strong>üìÑ ${a.date}</strong><span class="archive-badge ${a.is_surplus ? 'surplus' : 'main'}">${a.type}</span></div>${stats ? `<div class="archive-stats">${stats}</div>` : ''}<div class="archive-actions"><button class="download-btn" onclick="downloadArchive('${a.filename}')">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button><button class="delete-archive-btn" onclick="deleteArchive('${a.filename}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button></div></div>`; } el.innerHTML = html; } catch (e) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div>–ü–æ–º–∏–ª–∫–∞</div>'; } }

function downloadArchive(f) { window.open(`/api/archive/download/${f}`, '_blank'); tg.HapticFeedback.notificationOccurred('success'); }
async function deleteArchive(filename) { if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª "${filename}"?`)) return; try { const r = await fetch(`/api/archive/delete/${filename}?user_id=${userId}`, { method: 'DELETE' }); const d = await r.json(); if (d.success) { tg.showAlert(`‚úÖ ${d.message}`); tg.HapticFeedback.notificationOccurred('success'); loadArchives(); } else { tg.showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è'); } } catch (e) { tg.showAlert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message); } }
if (userId) loadList();
updateSearchBoxVisibility();
</script>
</body>
</html>
